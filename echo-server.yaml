# echo-server.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-server
spec:
  replicas: 90
  selector:
    matchLabels:
      app: echo
  template:
    metadata:
      labels:
        app: echo
    spec:
      containers:
        - name: echo
          image: python:3.11-slim
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          command: ["python", "-u", "-c"]
          args:
            - |
              import os
              import time

              from http.server import BaseHTTPRequestHandler, HTTPServer

              POD_NAME = os.getenv("POD_NAME", "unknown")

              class Handler(BaseHTTPRequestHandler):
                  request_counter = 0

                  def do_GET(self):
                      #Handler.request_counter += 1
                      #if Handler.request_counter % 10 == 0:
                      #    time.sleep(1)  # задержка в 1 секунду
              
                      self.send_response(200)
                      self.send_header('Content-type', 'text/plain')
                      self.send_header('X-Pod-Name', POD_NAME)
                      self.send_header('Connection', 'close')  # Принудительно закрываем соединение
                      self.end_headers()
                      self.wfile.write(f"Pod {POD_NAME}\n".encode())
                      
                  def log_message(self, format, *args):
                      pass  # Отключаем логирование для производительности

              server = HTTPServer(('', 5678), Handler)
              print(f"Starting server on port 5678, Pod: {POD_NAME}")
              server.serve_forever()
          ports:
            - containerPort: 5678
          readinessProbe:
            httpGet:
              path: /
              port: 5678
            initialDelaySeconds: 1
            periodSeconds: 1
          livenessProbe:
            httpGet:
              path: /
              port: 5678
            initialDelaySeconds: 5
            periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: echo-service
spec:
  selector:
    app: echo
  ports:
    - protocol: TCP
      port: 80
      targetPort: 5678
  # Настройки для лучшего распределения
  sessionAffinity: None
  type: ClusterIP
